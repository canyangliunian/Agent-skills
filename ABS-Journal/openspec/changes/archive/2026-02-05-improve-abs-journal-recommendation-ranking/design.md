## Context

当前推荐实现（`scripts/abs_article_impl.py`）的核心流程是：

- 读取本地 AJG CSV（不联网）。
- 依据 `field` 做一个较粗的候选筛选（`pick_candidates()`）。
- 依据 `mode` 计算一个 `total_score = f(keyword_score, easiness_score, prestige_penalty, ajg_level)`。
- 对所有候选按 `total_score` 排序后截取 `topk`，再按 AJG 星级分桶输出。

目前的问题在于：

- “主题贴合”只作为 `keyword_score` 的加分项参与总分，并没有作为硬约束；因此 `easy/value` 模式可能把与主题不太相关但指标更“易/值”的期刊排在前面。
- `value` 模式对星级（尤其 4/4*）权重较高时，会让结果看起来像“只推 4★”；`easy` 模式也可能让结果看起来像“只推 1★”，这与用户的真实需求（先贴合，再 easy/value）不一致。
- 报告输出没有明确展示“贴合分/阈值/为何被筛掉”，用户难以理解推荐理由。

约束：

- 默认仍坚持“本地 CSV 优先，不自动更新/不联网抓取”。
- 需要尽量保持 CLI 参数兼容（`--mode/--topk/--title/--abstract/--field` 等不破坏），以避免已有用法失效。

## Goals / Non-Goals

**Goals:**

- 引入统一的“主题贴合候选集（Topic Fit Gating）”：所有模式都必须先通过贴合阈值，才进入排序。
- 让三个模式的目标清晰且一致：
  - `fit`：最贴合（在候选集内按贴合分优先）。
  - `easy`：在贴合前提下更容易发表（在候选集内按易发表代理指标优先）。
  - `value`：在贴合前提下更有价值/更高星（在候选集内按价值代理指标优先）。
- 增强可解释性：输出贴合分、阈值、以及 easy/value 的关键构成指标，避免黑箱。
- 结果质量的“最小保障”：
  - 若通过阈值的候选过少，允许自动降阈值或回退策略（需明确提示），以避免空结果或过少结果。

**Non-Goals:**

- 不引入需要联网的外部数据（审稿周期、APC、编辑偏好等）。
- 不在本次变更中追求学术级 NLP/embedding；贴合打分先采用可复现、可解释、完全离线的方法。
- 不改变 AJG 数据抓取流程（除非后续需求明确提出更新/扩充字段）。

## Decisions

1) 统一两阶段流程：`筛选(贴合)` → `排序(按模式)`

- 决策：将推荐拆分为两个阶段：
  - Stage A：计算每个期刊的 `fit_score`（主题贴合分）。
  - Stage B：只在 `fit_score >= threshold` 的候选集内，按 mode 计算排序分（`rank_score`）。
- 理由：把“贴合”变成硬约束，符合用户对三种模式的共同前提要求；同时保持排序逻辑可控、可解释。
- 备选方案：
  - 仅调整现有 `total_score` 权重（否决）：无法保证 easy/value 不偏离主题，也很难让用户信服。

2) 贴合分 `fit_score` 采用离线、可解释的“关键词覆盖 + 加权”方法（V1）

- 决策：短期（本次变更）使用现有的 `keyword_score()` 思路扩展为更稳健的 fit 计算：
  - 对 title+abstract 做 normalize。
  - 引入关键词组（可配置）与权重；对短语（如 "trade war"）优先匹配。
  - 允许把 `field` 作为弱先验加分，但不替代文本匹配。
- 理由：完全离线、简单可维护、可解释；当前代码已具备基础实现，改造成本低。
- 备选方案：
  - 引入 embedding/向量检索（暂缓）：需要新依赖与离线模型文件管理，复杂度高。

3) 阈值策略：默认“相对阈值 + 保底 topk 候选”

- 决策：阈值不采用固定绝对值（因为 `fit_score` 的尺度与关键词集合相关），采用：
  - `threshold = max(min_threshold, quantile(fit_score, q))` 之类的相对阈值；或
  - “先按 fit_score 排序取 `candidate_topn`”，再在该集合内做排序（等价于阈值）。
- 理由：不同论文主题下 fit 分布差异大，用相对阈值更稳；同时避免“候选为空”。
- 备选方案：
  - 固定阈值（否决）：容易出现某些主题全部被筛掉或全部通过，体验不稳定。

4) `easy` 与 `value` 的排序指标在候选集内独立定义，并降低“单一星级极化”

- 决策：
  - `easy`：以 `easiness_score()` 为主排序键，辅以 `fit_score` 次级排序（同 easy 下更贴合优先）；必要时加入轻量的 prestige 惩罚以避免极高门槛期刊误判为 easy。
  - `value`：以 AJG 星级（含 4*）为主，但加入 `fit_score` 次级排序，并保留适度的 prestige 惩罚；确保“高星但不贴合”的不会进入候选集。
- 理由：与用户目标一致；并通过候选集约束解决“value 必须适合主题”的前提。
- 备选方案：
  - 继续在 `total_score` 中混合（否决）：难以解释，也容易产生极端结果。

5) 输出增强：在报告中显式展示 `fit_score` 与候选门槛说明

- 决策：
  - 在 Markdown 表格中新增列：`FitScore`（或“贴合分”）、以及 `EasyScore/ValueScore`（按模式选择显示）。
  - 在“说明”区域新增：候选集构造方式（阈值/TopN）、以及降阈值/回退是否发生。
- 理由：让用户理解“为什么是这些期刊”，并减少“只推 1★/4★”的误解。

## Risks / Trade-offs

- [贴合分仍然依赖关键词] → Mitigation：把关键词字典外置为可配置文件/或 CLI 参数（后续 specs/tasks 明确），并在报告中提示“基于关键词的离线近似”。
- [阈值策略可能导致候选过少/过多] → Mitigation：采用“相对阈值 + 候选 topN 保底 + 明示回退”的组合，并在测试用例覆盖极端输入（无摘要、极短摘要、跨领域）。
- [模式排序与分桶展示可能产生认知冲突] → Mitigation：排序在候选集内进行，但展示仍按 AJG 分桶；在 bucket 内保持排序一致，并在说明中解释“展示分桶 ≠ 推荐只限某星级”。
